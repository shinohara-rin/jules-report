commit f3661f896805d5985da465044082a35b20780ae8
Author: Neko Ayaka <neko@ayaka.moe>
Date:   Sun Jan 4 04:22:31 2026 +0800

    fix(stage-layouts): should peserve blur for background

diff --git a/packages/stage-layouts/src/stores/background.ts b/packages/stage-layouts/src/stores/background.ts
index b7907d72..fe10386e 100644
--- a/packages/stage-layouts/src/stores/background.ts
+++ b/packages/stage-layouts/src/stores/background.ts
@@ -5,7 +5,7 @@ import localforage from 'localforage'

 import { useLocalStorage, useObjectUrl } from '@vueuse/core'
 import { defineStore } from 'pinia'
-import { computed, markRaw, onScopeDispose, ref, shallowRef } from 'vue'
+import { computed, markRaw, onScopeDispose, ref, shallowRef, watch } from 'vue'

 import { DefaultBackgroundPreview } from '../components/Backgrounds/default'

@@ -23,6 +23,8 @@ type PersistedBackgroundItem = Omit<BackgroundItem, 'file'> & {
   file?: Blob
 }

+type BackgroundPreferenceRecord = Record<string, Pick<BackgroundOption, 'id' | 'blur'>>
+
 export const useBackgroundStore = defineStore('background', () => {
   // TODO: STORAGE_PREFIX used with multiple less maintainable `localforage` and `key.startsWith(...)` call that creates complexity.
   const STORAGE_PREFIX = 'background-'
@@ -36,17 +38,40 @@ export const useBackgroundStore = defineStore('background', () => {
     },
   ]

-  const options = ref<BackgroundItem[]>([...presets])
   const loading = ref(false)
+  const galleryOptions = useLocalStorage<BackgroundPreferenceRecord>('settings/theme/background/gallery-options', {})
+  const galleryId = useLocalStorage<string>('settings/theme/background/gallery-active', presets[0]?.id)
+  const storedOptions = ref<BackgroundItem[]>([])

-  const selectedId = useLocalStorage<string>('settings/theme/background/selected-id', options.value[0]?.id)
   const sampledColor = useLocalStorage<string>('settings/theme/background/sampled-color', '')
+  const selectedId = computed({
+    get: () => galleryId.value,
+    set: value => galleryId.value = value,
+  })
+  const options = computed(() => {
+    const merged = [...presets, ...storedOptions.value].map((option) => {
+      const stored = galleryOptions.value[option.id]
+      if (!stored || stored.blur === undefined || option.blur === stored.blur)
+        return option
+
+      return {
+        ...option,
+        blur: stored.blur,
+      }
+    })

+    return [...merged].sort((a, b) => (b.importedAt ?? 0) - (a.importedAt ?? 0))
+  })
   const selectedOption = computed(() => options.value.find(option => option.id === selectedId.value) ?? options.value[0])

   const blobRefs = new Map<string, ShallowRef<Blob | undefined>>()
   const urlRefs = new Map<string, Readonly<Ref<string | undefined>>>()

+  watch(options, (next) => {
+    if (!next.some(option => option.id === selectedId.value))
+      selectedId.value = next[0]?.id
+  })
+
   function ensureObjectUrl(id: string, blob: Blob) {
     let blobRef = blobRefs.get(id)
     let urlRef = urlRefs.get(id)
@@ -74,10 +99,14 @@ export const useBackgroundStore = defineStore('background', () => {
       const blob = await (await fetch(dataUrl)).blob()
       const objectUrl = ensureObjectUrl(key, blob)

-      const existing = options.value.find(o => o.id === key)
-      if (existing) {
-        existing.src = objectUrl
-        existing.file = undefined
+      const existingIndex = storedOptions.value.findIndex(o => o.id === key)
+      if (existingIndex >= 0) {
+        const existing = storedOptions.value[existingIndex]
+        storedOptions.value.splice(existingIndex, 1, {
+          ...existing,
+          src: objectUrl,
+          file: undefined,
+        })
       }

       const payload: PersistedBackgroundItem = {
@@ -93,6 +122,18 @@ export const useBackgroundStore = defineStore('background', () => {
     }
   }

+  function persistSelectionOptions(option: BackgroundItem) {
+    const payload: Pick<BackgroundOption, 'id' | 'blur'> = {
+      id: option.id,
+      blur: option.blur ?? false,
+    }
+
+    galleryOptions.value = {
+      ...galleryOptions.value,
+      [option.id]: payload,
+    }
+  }
+
   function setSelection(option: BackgroundItem, color?: string) {
     selectedId.value = option.id
     if (color)
@@ -111,15 +152,20 @@ export const useBackgroundStore = defineStore('background', () => {
       kind,
     }

+    persistSelectionOptions(selection)
+
     const saved = await addOption(selection)
     setSelection(saved, payload.color)
+
     return saved
   }

   async function loadFromIndexedDb() {
     if (loading.value)
       return
+
     loading.value = true
+
     const stored: BackgroundItem[] = []
     try {
       await localforage.iterate<PersistedBackgroundItem, void>((val, key) => {
@@ -166,7 +212,7 @@ export const useBackgroundStore = defineStore('background', () => {
       console.error('Failed to load backgrounds from IndexedDB', error)
     }

-    options.value = [...presets, ...stored].sort((a, b) => (b.importedAt ?? 0) - (a.importedAt ?? 0))
+    storedOptions.value = stored
     loading.value = false
   }

@@ -194,13 +240,14 @@ export const useBackgroundStore = defineStore('background', () => {
       removable: true,
     }

-    const existing = options.value.find(o => o.id === normalizedId)
-    if (existing) {
-      Object.assign(existing, normalizedOption)
+    const existingIndex = storedOptions.value.findIndex(o => o.id === normalizedId)
+    if (existingIndex >= 0) {
+      storedOptions.value.splice(existingIndex, 1, normalizedOption)
     }
-    else {
-      options.value.push(normalizedOption)
+    else if (normalizedId.startsWith(STORAGE_PREFIX)) {
+      storedOptions.value = [...storedOptions.value, normalizedOption]
     }
+
     selectedId.value = normalizedId

     if (hasUploadedFile && storedBlob) {
@@ -243,19 +290,21 @@ export const useBackgroundStore = defineStore('background', () => {
     const blobRef = blobRefs.get(optionId)
     if (blobRef)
       blobRef.value = undefined
+
     blobRefs.delete(optionId)
     urlRefs.delete(optionId)

-    // Remove from list
-    options.value.splice(optionIndex, 1)
+    const storedIndex = storedOptions.value.findIndex(o => o.id === optionId)
+    if (storedIndex >= 0)
+      storedOptions.value.splice(storedIndex, 1)
+    if (galleryOptions.value[optionId]) {
+      const { [optionId]: _, ...rest } = galleryOptions.value
+      galleryOptions.value = rest
+    }

     // If selected, fallback to first available option
-    if (selectedId.value === optionId) {
-      const fallback = options.value[0]
-      if (fallback) {
-        selectedId.value = fallback.id
-      }
-    }
+    if (selectedId.value === optionId)
+      selectedId.value = options.value[0]?.id
   }

   function setSampledColor(color?: string) {
